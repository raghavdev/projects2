"use strict";var valenceApp=angular.module("valence",["valenceAuth"]);valenceApp.run(["model",function(){}]),window.valence={},valence.models=[],valence.model=function(model,fields){for(var match=!1,obj={},i=0;i<valence.models.length;i++)valence.models[i].name===model&&(match=!0);if(!match){obj.name=model;for(var prop in fields)obj[prop]=fields[prop];valence.models.push(obj)}},window.Collection="Collection",window._model="_model","undefined"==typeof document||"classList"in document.documentElement||!function(view){if("HTMLElement"in view||"Element"in view){var classListProp="classList",protoProp="prototype",elemCtrProto=(view.HTMLElement||view.Element)[protoProp],objCtr=Object,strTrim=String[protoProp].trim||function(){return this.replace(/^\s+|\s+$/g,"")},arrIndexOf=Array[protoProp].indexOf||function(item){for(var i=0,len=this.length;len>i;i++)if(i in this&&this[i]===item)return i;return-1},DOMEx=function(type,message){this.name=type,this.code=DOMException[type],this.message=message},checkTokenAndGetIndex=function(classList,token){if(""===token)throw new DOMEx("SYNTAX_ERR","An invalid or illegal string was specified");if(/\s/.test(token))throw new DOMEx("INVALID_CHARACTER_ERR","String contains an invalid character");return arrIndexOf.call(classList,token)},ClassList=function(elem){for(var trimmedClasses=strTrim.call(elem.className),classes=trimmedClasses?trimmedClasses.split(/\s+/):[],i=0,len=classes.length;len>i;i++)this.push(classes[i]);this._updateClassName=function(){elem.className=this.toString()}},classListProto=ClassList[protoProp]=[],classListGetter=function(){return new ClassList(this)};if(DOMEx[protoProp]=Error[protoProp],classListProto.item=function(i){return this[i]||null},classListProto.contains=function(token){return token+="",-1!==checkTokenAndGetIndex(this,token)},classListProto.add=function(){var token,tokens=arguments,i=0,l=tokens.length,updated=!1;do token=tokens[i]+"",-1===checkTokenAndGetIndex(this,token)&&(this.push(token),updated=!0);while(++i<l);updated&&this._updateClassName()},classListProto.remove=function(){var token,tokens=arguments,i=0,l=tokens.length,updated=!1;do{token=tokens[i]+"";var index=checkTokenAndGetIndex(this,token);-1!==index&&(this.splice(index,1),updated=!0)}while(++i<l);updated&&this._updateClassName()},classListProto.toggle=function(token,forse){token+="";var result=this.contains(token),method=result?forse!==!0&&"remove":forse!==!1&&"add";return method&&this[method](token),!result},classListProto.toString=function(){return this.join(" ")},objCtr.defineProperty){var classListPropDesc={get:classListGetter,enumerable:!0,configurable:!0};try{objCtr.defineProperty(elemCtrProto,classListProp,classListPropDesc)}catch(ex){-2146823252===ex.number&&(classListPropDesc.enumerable=!1,objCtr.defineProperty(elemCtrProto,classListProp,classListPropDesc))}}else objCtr[protoProp].__defineGetter__&&elemCtrProto.__defineGetter__(classListProp,classListGetter)}}(self),valenceApp.provider("valence",{modelAPI:{},loader:{},model:null,models:[],viewModel:"",compileTarget:document.body,retrievalQueue:[],persistenceQueue:[],timers:[],retrievalProcessing:!1,persistenceProcessing:!1,applyQueue:[],appliedModels:[],$get:function(){return this.model=valence.model,this.models=valence.models,valence=this,this}}),valenceApp.service("model",["valence","cloud","store","loader","$route","$rootScope","$location","$rootElement","$q","$routeParams",function(valence,cloud,store,loader,$route,$rootScope,$location,$rootElement,$q,$routeParams){function safeApply(scope,fn){var applier=setInterval(function(){var phase=scope.$$phase;"$apply"!=phase&&"$digest"!=phase&&(clearInterval(applier),scope.$apply(fn))},100)}function splitAndStrip(obj){var stripped=[];obj=obj.split("/");for(var i=0;i<obj.length;i++)""!==obj[i]&&stripped.push(obj[i]);return stripped}function getRouteParams(){var def=$q.defer(),elapsed=0,paramChecker=setInterval(function(){Object.keys($routeParams).length?(clearInterval(paramChecker),def.resolve($routeParams)):(elapsed+=300,elapsed>=1e3&&(clearInterval(paramChecker),def.resolve(null)))},300);return def.promise}function apply(model,opts,data,promise){var scope,matchCount,matchedCount,scopes=document.querySelectorAll(".ng-scope"),fields=opts.fields;promise&&(promise.resolve(data),loader.loaded(model)),data=serialize(opts,data);for(var i=0;i<scopes.length;i++)if(!scopes[i].hasAttribute("ng-repeat")&&(scope=angular.element(scopes[i]).scope(),scope&&fields)){matchCount=0,matchedCount=0;for(var field in fields)matchCount++,scope.hasOwnProperty(field)&&(matchedCount++,fields[field]===_model?scope[field]=data:data.constructor===Object?data.hasOwnProperty(field)&&(scope[field]=data[field]):scope[field]=data);matchedCount===matchCount&&(safeApply(scope),loader.loaded(model))}}function serialize(opts,data){var returnData,type=Array,castMappings={Array:function(data){return[data]},Object:function(data){var obj={};if(data.constructor!==Array&&(data=[data]),1===data.length)obj=data[0];else for(var i=0;i<data.length;i++)obj[i]=data[i];return obj},String:function(data){return data.toString()},Boolean:function(data){return!!data}};return type=getSerializeType(opts.type?opts.type:opts.belongsTo&&opts.belongsTo.type?opts.belongsTo.type:type),null===data.constructor.toString().match(type)?castMappings[type]&&(returnData=castMappings[type](data)):returnData=data,returnData}function getSerializeType(type){for(var supportedTypes=["Array","String","Boolean","Object"],returnType=!1,i=0;i<supportedTypes.length;i++)type.toString().match(supportedTypes[i])&&(returnType=supportedTypes[i]);return returnType}function loadViewModel(){var routeSegs,urlSegs=splitAndStrip($location.path()),routeMached=!1;valence.appliedModels=[],loader.run(),getRouteParams().then(function(data){for(var route in $route.routes){var paramCounter=0,paramMatchedCounter=0,paramsPassed=!1,uriCounter=0,uriMatchedCounter=0,urisPassed=!1;if(route===$location.path()){if(!$route.routes[route].model)return void loader.finish();$route.routes[route].model.constructor!==Array&&($route.routes[route].model=[$route.routes[route].model]);for(var m=0;m<$route.routes[route].model.length;m++)for(var i=0;i<valence.models.length;i++)valence.models[i].name===$route.routes[route].model[m]&&Model.get(valence.models[i].name,valence.models[i])}if(routeSegs=splitAndStrip(route),routeSegs.length===urlSegs.length&&data){for(var i=0;i<routeSegs.length;i++)if(null!==routeSegs[i].match(":"))for(var param in data)paramCounter++,null!==routeSegs[i].match(param)&&paramMatchedCounter++;else uriCounter++,routeSegs[i]===urlSegs[i]&&uriMatchedCounter++;if(paramCounter&&paramMatchedCounter&&paramCounter===paramMatchedCounter&&(paramsPassed=!0),uriCounter&&uriMatchedCounter&&uriCounter===uriMatchedCounter&&(urisPassed=!0),paramsPassed&&urisPassed&&!routeMached&&(routeMached=!0,$route.routes[route].model)){$route.routes[route].model.constructor!==Array&&($route.routes[route].model=[$route.routes[route].model]);for(var m=0;m<$route.routes[route].model.length;m++)for(var i=0;i<valence.models.length;i++)valence.models[i].name===$route.routes[route].model[m]&&Model.get(valence.models[i].name,valence.models[i])}}}loader.finish()})}var Model=function(){if(!valence.models.length)throw'valence - no models in valence.models were found. Add a model by using: valence.model("myModelName", {})'};Model.fn=Model.prototype={getter:{init:function(model,opts,promise){var standAlone,query,self=this,belongsTo=!1,hasMany=!1;return opts||(opts=Model.fn.getModelConfig(model)),belongsTo=!!opts.belongsTo,hasMany=!!opts.hasMany,standAlone=self.isStandAlone(opts),belongsTo?this.init(opts.belongsTo.model,null,promise):(query=Model.fn.buildParamQuery(opts),void store.getModel(model,opts,query).then(function(storeGetData){hasMany&&!standAlone?(apply(model,opts,storeGetData),self.hasMany(model,opts.hasMany.model,null,promise)):apply(model,opts,storeGetData,promise)},function(){cloud.fetchModel(model,opts,query).then(function(cloudGetData){opts.serializer&&(cloudGetData=opts.serializer(cloudGetData)),store.setModel(model,cloudGetData).then(function(storeSaveData){hasMany&&!standAlone?(apply(model,opts,storeSaveData),self.hasMany(model,opts.hasMany.model,null,promise)):apply(model,opts,storeSaveData,promise)},function(){})},function(){})}))},hasMany:function(parentModel,model,opts,promise){var query,self=this,hasMany=!1,parentOpts=Model.fn.getModelConfig(parentModel);opts||(opts=Model.fn.getModelConfig(model)),hasMany=!!opts.hasMany,query=Model.fn.buildParamQuery(opts.belongsTo),store.getModel(model,opts,query).then(function(storeGetData){hasMany?(apply(model,opts,storeGetData),self.hasMany(model,opts.hasMany.model,null,promise)):apply(model,opts,storeGetData,promise)},function(){opts.HTTP&&parentOpts.HTTP&&opts.HTTP.GET&&parentOpts.HTTP.GET&&opts.HTTP.GET.url===parentOpts.HTTP.GET.url||opts.HTTP&&opts.HTTP.GET.url===parentModel||!opts.HTTP?store.getModel(parentModel,parentOpts,query).then(function(storeGetFromParentData){store.setModel(model,storeGetFromParentData).then(function(storeSetFromParentData){hasMany?(apply(model,opts,storeSetFromParentData),self.hasMany(model,opts.hasMany.model,null,promise)):apply(model,opts,storeSetFromParentData,promise)},function(){})},function(){cloud.fetchModel(model,opts,query).then(function(cloudGetData){opts.serializer&&(cloudGetData=opts.serializer(cloudGetData)),store.setModel(model,cloudGetData).then(function(storeSaveData){hasMany?(apply(model,opts,storeSaveData),self.hasMany(model,opts.hasMany.model,null,promise)):apply(model,opts,storeSaveData,promise)},function(storeSaveData){promise.reject(storeSaveData)})},function(cloudGetData){promise.reject(cloudGetData)})}):store.getModel(model,opts,query).then(function(storeGetData){hasMany?(apply(model,opts,storeGetData),self.hasMany(opts.hasMany.model,null,promise)):apply(model,opts,storeGetData,promise)},function(){cloud.fetchModel(model,opts,query).then(function(cloudGetData){opts.serializer&&(cloudGetData=opts.serializer(cloudGetData)),store.setModel(model,cloudGetData).then(function(storeSaveData){hasMany?(apply(model,opts,storeSaveData),self.hasMany(opts.hasMany.model,null,promise)):apply(model,opts,storeSaveData,promise)},function(storeSaveData){promise.reject(storeSaveData)})},function(cloudGetData){promise.reject(cloudGetData)})})})},isStandAlone:function(opts){var urlSegs,isStandAlone=!1,routeSegs=splitAndStrip($location.path()),segMatch=0,url=$location.path();if(opts.standAlone)if(opts.standAlone.url===url)isStandAlone=!0;else if(urlSegs=splitAndStrip(opts.standAlone),routeSegs.length===urlSegs.length){for(var i=0;i<routeSegs.length;i++)routeSegs[i]===urlSegs[i]?segMatch++:$routeParams[urlSegs[i].split(":")[1]]&&routeSegs[i]===$routeParams[urlSegs[i].split(":")[1]]&&segMatch++;segMatch===routeSegs.length&&(isStandAlone=!0)}return isStandAlone}},setter:{init:function(action,model,data,promise){var hasMany,query,opts=Model.fn.getModelConfig(model);loader.run(model,opts),hasMany=!(!opts.hasMany||!opts.hasMany.model),query=Model.fn.buildParamQuery(opts.HTTP[action.toUpperCase()]),cloud.saveModel(model,action,opts,query,data).then(function(){cloud.fetchModel(model,opts,Model.fn.buildParamQuery(opts.HTTP.GET)).then(function(cloudGetData){store.setModel(model,cloudGetData).then(function(storeSaveData){hasMany&&Model.fn.getModelConfig(opts.hasMany.model).belongsTo.model===model?store.deleteModel(opts.hasMany.model).then(function(){apply(model,opts,storeSaveData,promise)}):apply(model,opts,storeSaveData,promise)},function(storeSaveData){promise.reject(storeSaveData),loader.loaded(model)})},function(){})},function(cloudSaveData){promise.reject(cloudSaveData),loader.loaded(model)})}},getModelConfig:function(model){for(var config,i=0;i<valence.models.length;i++)valence.models[i].name===model&&(config=valence.models[i]);if(!config)throw"Valence - model for ["+model+"] not found. Make sure to declare one through valence.model()";return config},buildParamQuery:function(opts){var predicate,query={};if(opts&&(opts.by?predicate=["by"]:opts.params&&!opts.data?predicate=["params"]:opts.data&&!opts.params?predicate=["data"]:opts.params&&opts.data&&(predicate=["params","data"])),predicate)for(var i=0;i<predicate.length;i++)for(var param in opts[predicate[i]])$routeParams[param]&&(query[predicate[i]]||(query[predicate[i]]={}),query[predicate[i]][opts[predicate[i]][param]]=$routeParams[param]);return Object.keys(query).length?query:!1}};var API={};return API.get=Model.get=Model.fn.get=function(model,opts){var def=$q.defer();return Model.fn.getter.init(model,opts,def),def.promise},API.put=Model.put=Model.fn.set=function(model,data){var def=$q.defer();return Model.fn.setter.init("PUT",model,data,def),def.promise},API.post=Model.post=Model.fn.set=function(model,data){var def=$q.defer();return Model.fn.setter.init("POST",model,data,def),def.promise},API.remove=Model.remove=Model.fn.remove=function(model,data,def){var def=$q.defer();return Model.fn.remove(model),def.promise},window.valenceModel=API,$rootScope.save=API.post,$rootScope.update=API.put,$rootScope.remove=API.remove,$rootScope.$on("$locationChangeSuccess",function(){loadViewModel()}),new Model}]),valenceApp.service("store",["valence","$q",function(valence,$q){var Adapters={};Adapters.localStorage={get:function(model){var data,store=JSON.parse(window.localStorage.valenceStore);return store.hasOwnProperty(model)&&(data=store[model]),data},set:function(model,data){var store=JSON.parse(window.localStorage.valenceStore);return store[model]=data,window.localStorage.valenceStore=JSON.stringify(store),this.get(model)},remove:function(model){var store=JSON.parse(window.localStorage.valenceStore);return store.hasOwnProperty(model)?(delete store[model],window.localStorage.valenceStore=JSON.stringify(store),!0):!1}};var Store=function(){return this.store=valence.storageEngine&&valence.storageEngine.primary?valence.storageEngine.primary:valence.storageEngine&&valence.storageEngine.fallbackToMemory?"memory":window.localStorage?"localStorage":[],"localStorage"===this.store&&void 0===window.localStorage.valenceStore&&(window.localStorage.valenceStore=JSON.stringify({})),window.Store=this};return Store.prototype.getModel=function(model,opts,query){var result,def=$q.defer(),data=Adapters[this.store].get(model),qLen=0,mLen=0;if(data)if(query){for(var type in query)for(var param in query[type])qLen++;if(data.constructor===Array){result=[];for(var i=0;i<data.length;i++){if(data[i].constructor===Object)for(var type in query)for(var param in query[type])data[i][param]&&data[i][param]==query[type][param]&&(mLen++,qLen&&mLen&&qLen===mLen&&-1===result.indexOf(data[i])&&result.push(data[i]));mLen=0}result.length?def.resolve(result):def.reject(result)}else if(data.constructor===Object){for(var type in query)for(var param in query[type])qLen++,data[param]&&data[param]===query[type][param]&&mLen++;qLen&&mLen&&qLen===mLen?def.resolve(data):def.reject(data)}}else def.resolve(data);else def.reject(!1);return def.promise},Store.prototype.setModel=function(model,data){var res,def=$q.defer();return res=Adapters[this.store].set(model,data),res?def.resolve(res):def.reject(!1),def.promise},Store.prototype.deleteModel=function(model){var def=$q.defer();return Adapters[this.store].remove(model)?def.resolve(!0):def.reject(!1),def.promise},new Store}]),valenceApp.service("loader",["valence",function(valence){var Loader=function(){return this.queue=[],this.enabled=valence.loader&&valence.loader.enabled===!1?!1:!0,this.loaderStarted=null,this.loaderClasses={hide:valence.loader.classes&&valence.loader.classes.hide?valence.loader.classes.hide:"ngLoader-hidden",show:valence.loader.classes&&valence.loader.classes.show?valence.loader.classes.show:"ngLoader-visible"},this.loaderCollection=[],this.contentCollection=[],this.minLoaderDisplayTime=valence.loader.minLoaderDisplayTime||500,this.enabled?this:this.prototype={run:function(){},loaded:function(){},finish:function(){},wrapUp:function(){},halt:function(){}}};return Loader.prototype.run=function(model,opts){var content=valence.loader.content,loaderElem=valence.loader.loader;if(this.enabled){model&&(this.queue.push({name:model,opts:opts}),model.loader&&(opts.loader.content&&(content=opts.loader.content),opts.loader.loader&&(loaderElem=opts.loader.loader))),this.loaderStarted||(this.loaderStarted=(new Date).getTime()),content=document.querySelectorAll(content).length?document.querySelectorAll(content):function(){throw"valence - ngLoader - It was requested that ["+content+"] be hidden when initiating the loader, however, no elements could be found in the DOM"}(),loaderElem=document.querySelectorAll(loaderElem).length?document.querySelectorAll(loaderElem):function(){throw"valence - ngLoader - It was requested that ["+loaderElem+"] be hidden when initiating the loader, however, no elements could be found in the DOM"}();for(var i=0;i<content.length;i++)content[i].classList.add(this.loaderClasses.hide),content[i].classList.remove(this.loaderClasses.show),this.contentCollection.push(content[i]);for(var i=0;i<loaderElem.length;i++)loaderElem[i].classList.add(this.loaderClasses.show),loaderElem[i].classList.remove(this.loaderClasses.hide),this.loaderCollection.push(loaderElem[i])}},Loader.prototype.loaded=function(model){var newQueue=[];if(!model)throw'valence - ngLoader - Loader.loaded must be passed a model so it knows how "done" it is and when to stop the loader.';for(var i=0;i<this.queue.length;i++)model!==this.queue[i].name&&newQueue.push(this.queue[i]);this.queue=newQueue,this.finish()},Loader.prototype.finish=function(){var finishedTime,self=this;this.queue.length||(finishedTime=(new Date).getTime(),finishedTime-this.loaderStarted>=this.minLoaderDisplayTime?this.wrapUp():setTimeout(function(){self.wrapUp()},self.minLoaderDisplayTime-(finishedTime-self.loaderStarted)),this.loaderStarted=null)},Loader.prototype.wrapUp=function(){this.contentCollection.length||(this.contentCollection=document.querySelectorAll(valence.loader.content).length?document.querySelectorAll(valence.loader.content):function(){throw"valence - ngLoader - It was requested that ["+valence.loader.content+"] be hidden when initiating the loader, however, no elements could be found in the DOM"}()),this.loaderCollection.length||(this.loaderCollection=document.querySelectorAll(valence.loader.loader).length?document.querySelectorAll(valence.loader.loader):function(){throw"valence - ngLoader - It was requested that ["+valence.loader.loader+"] be hidden when initiating the loader, however, no elements could be found in the DOM"}());for(var i=0;i<this.loaderCollection.length;i++)this.loaderCollection[i].classList.remove(this.loaderClasses.show),this.loaderCollection[i].classList.add(this.loaderClasses.hide);for(var i=0;i<this.contentCollection.length;i++)this.contentCollection[i].classList.remove(this.loaderClasses.hide),this.contentCollection[i].classList.add(this.loaderClasses.show);this.loaderCollection=[],this.contentCollection=[]},Loader.prototype.halt=function(){this.queue=[],this.finish()},new Loader}]),valenceApp.service("cloud",["valence","auth","$http","$q",function(valence,auth,$http,$q){function fetchModel(model,opts,query){var token,predicates,def=$q.defer(),httpOpts={};if(httpOpts.method="GET",httpOpts.url=baseEarl+model,httpOpts.params=null,opts.HTTP&&opts.HTTP.GET&&opts.HTTP.GET.url&&(httpOpts.url=baseEarl+opts.HTTP.GET.url),query){httpOpts.params={},predicates=Object.keys(query);for(var i=0;i<predicates.length;i++)for(var param in query[predicates[i]])httpOpts.params[param]=query[predicates[i]][param]}return opts&&opts.retrieval&&opts.retrieval.auth&&(token=Auth.getAuthParams().token,token&&(httpOpts.params.token=token)),$http(httpOpts).success(function(data){def.resolve(data)}).error(function(data,status,headers,config){def.reject({data:data,status:status,headers:headers,config:config})}),def.promise}function saveModel(model,action,opts,query,data){var token,def=$q.defer(),httpOpts={};if(action=action.toUpperCase(),httpOpts.method=action,httpOpts.url=baseEarl+model,httpOpts.params=null,opts.HTTP&&opts.HTTP[action]&&opts.HTTP[action].url&&(httpOpts.url=baseEarl+opts.HTTP[action].url),query&&query.params&&(httpOpts.params=query.params),httpOpts.data=data,query&&query.data)for(var key in query.data)httpOpts.data[key]=query.data[key];return opts&&opts.persistence&&opts.persistence.auth&&(token=auth.getAuthParams().token,token&&(httpOpts.params||(httpOpts.params={}),httpOpts.params.token=token)),$http(httpOpts).success(function(data){def.resolve(data)}).error(function(data,status,headers,config){def.reject({data:data,status:status,headers:headers,config:config})}),def.promise}var baseEarl=valence.api+"/";return{fetchModel:fetchModel,saveModel:saveModel}}]);var auth=angular.module("valenceAuth",[]);auth.service("auth",["valenceAuth","$rootScope","$location","$route","$http","$routeParams","$q",function(valenceAuth,$rootScope,$location,$route,$http,$routeParams,$q){var Service,onceAuthedQueue=[],Auth=function(){if(valenceAuth.enabled){if(!valenceAuth.endpoints)throw"valenceAuth - No endpoints config found. Make sure in your app's .config() you specify $valenceAuthProvider.endpoints = {}";if(!valenceAuth.endpoints.validate)throw"valenceAuth - The Endpoints config item requires a 'validate' property. This is the property we use to validate an identity's active session.";if(!valenceAuth.endpoints.login)throw"valenceAuth - The Endpoints config item requires a 'login' property. This is the property we use to create a user auth identity.";if(!valenceAuth.endpoints.logout)throw"valenceAuth - The Endpoints config item requires a 'logout' property. This is the property we use to destroy a user auth identity.";return this.isValidated=!1,this.dataStore=valenceAuth.dataStore,this.roles=valenceAuth.roles,this.firstVisit=!0,this.scheme=valenceAuth.scheme,this.token=null,this}};return Auth.prototype.validate=function(route,redirect){var self=this,token=window.localStorage.token;$http({method:valenceAuth.endpoints.validate.method,url:valenceAuth.endpoints.validate.URL,withCredentials:!0,params:{token:token}}).success(function(data){route.auth&&route.auth.roles?self.validateRoles(route).then(function(){self.postFlow({isValidated:!0,setIdentity:data}),redirect&&redirect.roles.success&&$location.path(redirect.roles.success)},function(){redirect&&redirect.roles.fail&&$location.path(redirect.roles.fail)}):(self.postFlow({isValidated:!0,setIdentity:data}),redirect&&redirect.auth.success&&$location.path(redirect.auth.success))}).error(function(){self.postFlow({isValidated:!1,setIdentity:null}),redirect&&redirect.auth.fail&&$location.path(redirect.auth.fail)})},Auth.prototype.login=function(userData){var self=this;if(!userData)throw"valenceAuth - you must provide credentials to this method.";$http({method:valenceAuth.endpoints.login.method,url:valenceAuth.endpoints.login.URL,data:userData}).success(function(data){var token=data[self.scheme.name]?data[self.scheme.name]:"",identity=data[self.scheme.identity];self.postFlow({isValidated:!0,setToken:token,setIdentity:identity}),self.parseRoutes(!0),$location.path(valenceAuth.endpoints.new.success)}).error(function(){self.postFlow({isValidated:!1,setToken:null}),$location.path(valenceAuth.endpoints.new.fail)})},Auth.prototype.logout=function(){var self=this;$http({method:valenceAuth.endpoints.logout.method,url:valenceAuth.endpoints.logout.URL,params:{token:self.getToken()}}).success(function(){valenceAuth.endpoints.new.success&&(self.postFlow({isValidated:!1,setToken:null}),$location.path(valenceAuth.endpoints.new.success))}).error(function(){valenceAuth.endpoints.new.fail&&$location.path(valenceAuth.endpoints.new.fail)})},Auth.prototype.new=function(userData){var self=this;return userData?$http({method:valenceAuth.endpoints.new.method,url:valenceAuth.endpoints.new.URL,data:userData}).success(function(data){valenceAuth.endpoints.new.validateOnNew&&self.postFlow({isValidated:!0,setToken:data[self.scheme.name],setIdentity:data.user}),valenceAuth.endpoints.new.success&&$location.path(valenceAuth.endpoints.new.success)}).error(function(data){return data}):void 0},Auth.prototype.postFlow=function(opts){var self=this;for(var prop in opts)self[prop]&&self[prop].constructor===Function?self[prop](opts[prop]):self[prop]=opts[prop];self.runAuthedQueue(opts.data)},Auth.prototype.setToken=function(token){"localStorage"===this.scheme.storage?window.localStorage[this.scheme.name]=token:"cookie"===this.scheme.storage||(this.token=token)},Auth.prototype.getToken=function(){var token=null;return"localStorage"===this.scheme.storage?token=window.localStorage[this.scheme.name]:"cookie"===this.scheme.storage||(token=this.token),token},Auth.prototype.setIdentity=function(data){"localStorage"===this.scheme.storage?window.localStorage[this.scheme.identity]=JSON.stringify(data):"cookie"===this.scheme.storage||(this.identity=data)},Auth.prototype.getIdentity=function(){var identity=null;return"localStorage"===this.scheme.storage?(window.localStorage[this.scheme.identity]||(window.localStorage[this.scheme.identity]=JSON.stringify({})),identity=JSON.parse(window.localStorage[this.scheme.identity])):"cookie"===this.scheme.storage||(identity=this.identity),identity},Auth.prototype.getAuthParams=function(){var params;return"oAUth"===this.scheme.type,"token"===this.scheme.type&&(params={},params[this.scheme.name]=this.getToken()),params},Auth.prototype.onceAuthed=function(fn,opts){onceAuthedQueue.push({fn:fn,opts:opts})},Auth.prototype.runAuthedQueue=function(data){for(var tmp=[],i=0;i<onceAuthedQueue.length;i++)onceAuthedQueue[i].fn(data),onceAuthedQueue[i].opts&&!onceAuthedQueue[i].opts.runOnce&&tmp.push(onceAuthedQueue[i]);onceAuthedQueue=tmp},Auth.prototype.validateRoles=function(route){var def=$q.defer();if(route&&route.auth.roles&&route.auth.roles.length)for(var i=0;i<route.auth.roles.length;i++)for(var j=0;j<valenceAuth.roles.length;j++)route.auth.roles[i]===valenceAuth.roles[j].role&&valenceAuth.roles[j].fn.call(this,def,$routeParams,$route);else def.resolve();return def.promise},Auth.prototype.parseRoutes=function(force){var routeSegs,redirect,self=this,urlSegs=this.splitAndStrip($location.path()),routeMached=!1;this.getRouteParams().then(function(data){for(var route in $route.routes){var paramCounter=0,paramMatchedCounter=0,paramsPassed=!1,uriCounter=0,uriMatchedCounter=0,urisPassed=!1;if(route===$location.path()&&($route.routes[route].auth||valenceAuth.authEvery||force||self.firstVisit)&&($route.routes[route].auth&&$route.routes[route].auth.redirect&&(redirect=$route.routes[route].auth.redirect),self.validate($route.routes[route],redirect)),routeSegs=self.splitAndStrip(route),routeSegs.length===urlSegs.length&&data){for(var i=0;i<routeSegs.length;i++)if(null!==routeSegs[i].match(":"))for(var param in data)paramCounter++,null!==routeSegs[i].match(param)&&paramMatchedCounter++;else uriCounter++,routeSegs[i]===urlSegs[i]&&uriMatchedCounter++;paramCounter&&paramMatchedCounter&&paramCounter===paramMatchedCounter&&(paramsPassed=!0),uriCounter&&uriMatchedCounter&&uriCounter===uriMatchedCounter&&(urisPassed=!0),paramsPassed&&urisPassed&&!routeMached&&(routeMached=!0,($route.routes[route].auth||valenceAuth.authEvery||force||self.firstVisit)&&($route.routes[route].auth&&$route.routes[route].auth.redirect&&(redirect=$route.routes[route].auth.redirect),self.validate($route.routes[route],redirect)))}}return self.firstVisit=!1})},Auth.prototype.getRouteParams=function(){var def=$q.defer(),elapsed=0,paramChecker=setInterval(function(){Object.keys($routeParams).length?(clearInterval(paramChecker),setTimeout(function(){def.resolve($routeParams)},1e3-elapsed)):(elapsed+=300,elapsed>=1e3&&(clearInterval(paramChecker),def.resolve(null)))},300);return def.promise},Auth.prototype.splitAndStrip=function(obj){var stripped=[];obj=obj.split("/");for(var i=0;i<obj.length;i++)""!==obj[i]&&stripped.push(obj[i]);return stripped},this.Auth=new Auth,Service=this.Auth,valenceAuth.enabled&&$rootScope.$on("$routeChangeSuccess",function(){Service.parseRoutes()}),this.Auth}]),auth.provider("valenceAuth",function(){return{dataStore:[],scheme:{type:"token",name:"token",identity:"user",storage:"localStorage",transmissionMethod:"query"},$get:function(){return this.roles=valenceAuth.roles,this}}}),window.valenceAuth={},valenceAuth.roles=[],valenceAuth.role=function(role,fn){valenceAuth.roles.push({role:role,fn:fn})};